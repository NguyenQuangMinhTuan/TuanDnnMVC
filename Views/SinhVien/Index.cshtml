<div class="form-filter">
    <div class="form-row">
        <div style="margin: 10px 100px" class="form-group">
            <label style="margin-left:10px">Từ khóa</label>
            <input style="margin-left:10px; width:500px" class="1" type="text" id="tu-khoa-search" />

            <button style="width:92px; margin-left: 10px" type="button" class="1" id="filter-btn">Tìm kiếm</button>
            <button style="width:92px; margin: 0px 10px" type="button" class="1" id="filter-cancel-btn">Tất cả</button>
            <button style="width:92px" type="button" class="1" data-toggle="modal" data-target="#modalAdd">Thêm mới</button>
        </div>
    </div>
</div>

<hr />

<div class="table-tree-wrapper table-form-field">
    <div style="width:100%; margin:0 auto;">
        <table style="border:solid 1px" id="dataGrid" class="table table-striped" cellspacing="0">
            <thead>
                <tr>
                    <th class="center-align">STT</th>
                    <th>HoTen</th>
                    <th>DiaChi</th>
                    <th>NgaySinh</th>
                    <th>SoDienThoai</th>
                    <th>MaKhoa</th>
                    <th style="color:red; text-decoration: underline">Setting</th>
                    <th style="color:red; text-decoration: underline">Option</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

<!-- Modal add-->
<div class="modal right fade" id="modalAdd" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Thêm mới</h4>
                @*<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>*@
            </div>
            <div class="modal-body">
                <input id="HoTenAdd" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter name" />
            </div>
            <div class="modal-body">
                <input id="DiaChiAdd" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter Address" />
            </div>
            <div class="modal-body">
                <input id="NgaySinhAdd" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter Date of Birth" />
            </div>
            <div class="modal-body">
                <input id="SoDienThoaiAdd" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter Phone Number" />
            </div>
            @*<div class="modal-body">
                    <input id="MaKhoaAdd" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter Faculty" />
                </div>*@
            <div class="modal-body">
                <select style="width:100%" id="MaKhoaAdd">
                    <!-- option from script -->
                </select>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-primary" onclick="addData()">Thêm</button>
            </div>

        </div>
    </div>
</div>

<!-- Modal edit-->
<div class="modal right fade" id="modalEdit" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Cập nhật</h4>
                @*<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>*@
            </div>

            <div class="#">
                <input id="MaSinhVienEdit" type="hidden" class="form-control" />
            </div>
            <div class="modal-body">
                <input id="HoTenEdit" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter Name" />
            </div>
            <div class="modal-body">
                <input id="DiaChiEdit" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter Address" />
            </div>
            <div class="modal-body">
                <input id="NgaySinhEdit" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter Date of Birth" />
            </div>
            <div class="modal-body">
                <input id="SoDienThoaiEdit" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter Phone Number" />
            </div>
            @*<div class="modal-body">
                    <input id="MaKhoaEdit" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter Faculty" />
                </div>*@
            <div class="modal-body">
                <select style="width:100%" id="MaKhoaEdit">
                    <!-- option from script -->
                </select>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-primary" onclick="editData()">Lưu</button>
            </div>

        </div>
    </div>
</div>

<!-- Modal delete-->
<div class="modal right fade" id="modalDelete" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Xóa</h4>
                @*<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>*@
            </div>
            <div class="modal-body">
                <input id="idDelete" type="hidden" class="form-control" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-primary" onclick="deleteData()">Xóa</button>
            </div>

        </div>
    </div>
</div>

<!-- Modal AddClass -->
<div class="modal right fade" id="modalAddc" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Thêm vào lớp</h4>
                @*<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>*@
            </div>
            <div class="#">
                <input id="MaSinhVienAddc" required="required" type="hidden" autocomplete="off" class="form-control" />
            </div>

            <div class="modal-body">
                <select style="width:100%" id="MaLopAddc">
                    <!-- option from script -->
                </select>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-primary" onclick="addcData()">Thêm</button>
            </div>

        </div>
    </div>
</div>

<!-- Modal add absent-->
<div class="modal right fade" id="modalAddb" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Thêm vắng</h4>
                @*<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>*@
            </div>
            <div class="modal-body">
                <input id="MaSinhVienAddb" required="required" type="hidden" autocomplete="off" class="form-control" />

                <input id="HoTenAddb" required="required" type="hidden" autocomplete="off" class="form-control" />

                <input id="LyDoAddb" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter reason" />
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-primary" onclick="addbData()">Thêm</button>
            </div>

        </div>
    </div>
</div>

<!-- script for data edit dropdown khoa -->
<script>
    $(document).ready(function () {
        $('#MaKhoaAdd').select2({
            width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style',
            language: "vi",
            placeholder: "Chọn Khoa",
        });

        $.ajax({
            url: `${BASEURL}/api/TuanMVC/SinhVien_KhoaApi/Gets`,
            type: "POST",
            data: buildData(),
            success: function (data) {
                const MaKhoa = $('#MaKhoaAdd');
                MaKhoa.empty();
                if (data && data.length > 0) {

                    const DefaultOpt = $('<option>', {
                        value: ""
                    });
                    MaKhoa.append(DefaultOpt);

                    for (let i = 0; i < data.length; i++) {
                        const option = $('<option>', {
                            value: data[i].MaKhoa,
                            text: data[i].TenKhoa
                        });
                        MaKhoa.append(option);
                    }
                }
            },
            error: function (error) {
                console.error("Lỗi khi lấy dữ liệu khoa:", error);
            }
        });
    });

    $(document).ready(function () {
        function initializeSelect2(selector, parent) {
            $(selector).select2({
                width: '100%',
                language: "vi",
                placeholder: "Chọn Khoa",
                dropdownParent: parent
            });
        }

        function fetchKhoaData() {
            $.ajax({
                url: `${BASEURL}/api/TuanMVC/SinhVien_KhoaApi/Gets`,
                type: "POST",
                data: buildData(),
                success: function (data) {
                    console.log("Fetched Khoa Data:", data);
                    const MaKhoaAdd = $('#MaKhoaAdd');
                    const MaKhoaEdit = $('#MaKhoaEdit');
                    MaKhoaAdd.empty();
                    MaKhoaEdit.empty();
                    if (data && data.length > 0) {
                        const defaultOpt = $('<option>', { value: "" });
                        MaKhoaAdd.append(defaultOpt);
                        MaKhoaEdit.append(defaultOpt.clone());

                        data.forEach(item => {
                            const option = $('<option>', {
                                value: item.MaKhoa,
                                text: item.TenKhoa
                            });
                            MaKhoaAdd.append(option);
                            MaKhoaEdit.append(option.clone());
                        });
                    }
                },
                error: function (error) {
                    console.error("Error fetching Khoa data:", error);
                }
            });
        }

        function buildData() {
            let tuKhoa = $('#tu-khoa-search').val();
            return { "TuKhoa": tuKhoa };
        }

        fetchKhoaData();

        initializeSelect2('#MaKhoaAdd', $('#modalAdd'));
        $('#modalEdit').on('shown.bs.modal', function () {
            initializeSelect2('#MaKhoaEdit', $(this));
        });
    });
</script>


<!-- script for dropdown MaLop -->
<script>
    $(document).ready(function () {
        // Khởi tạo Select2 cho Select Dropdown
        $('#MaLopAddc').select2({
            width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style',
            language: "vi",
            placeholder: "Chọn Lớp",
        });


        $('#filter-btn').on('click', function () {
            // Lấy giá trị mã lớp đã chọn
            let maLop = $('#MaLopSelect').val();

            // Gán giá trị mã lớp đã chọn vào input ẩn
            if (maLop === 'all') {
                $('#ma-search').val(0);
            } else {
                $('#ma-search').val(maLop);
            }

            // Reload datatable sau khi nhấn nút "Tìm kiếm"
            $('#dataGrid').DataTable().ajax.reload().draw();
        });


        // Lấy danh sách Khoa từ API và điền vào Select Dropdown
        $.ajax({
            url: `${BASEURL}/api/TuanMVC/SinhVienLopApi/Gets`,
            type: "POST",
            data: buildData(),
            success: function (data) {
                const MaLop = $('#MaLopAddc');
                MaLop.empty(); // Xóa tất cả các option hiện có

                if (data && data.length > 0) {
                    for (let i = 0; i < data.length; i++) {
                        // Tạo một option mới cho mỗi mã lớp
                        const option = $('<option>', {
                            value: data[i].MaLop,
                            text: data[i].MaPhong
                        });
                        MaLop.append(option); // Thêm option vào select dropdown
                    }
                }
            },
            error: function (error) {
                console.error("Lỗi khi lấy dữ liệu khoa:", error);
            }
        });
    });

    // Hàm buildData
    function buildData() {
        let tuKhoa = $('#tu-khoa-search').val();
        const request = {
            "TuKhoa": tuKhoa,
        };
        return request;
    }
</script>

<!-- script for table -->
<script>
    const url = window.location;
    const BASEURL = url.protocol + "//" + url.hostname + url.port;

    $(document).ready(function () {
        $('#filter-btn').on('click', function () {
            $('#dataGrid').DataTable().ajax.reload().draw();
        });

        $('#filter-cancel-btn').on('click', function () {
            $('#tu-khoa-search').val("");

            $('#dataGrid').DataTable().ajax.reload().draw();
        });

        $('#tu-khoa-search').on("keydown", function search(e) {
            if (e.keyCode == 13) {
                $('#dataGrid').DataTable().ajax.reload().draw();
            }
        });

        function buildData() {
            let tuKhoa = $('#tu-khoa-search').val();

            const request = {
                "TuKhoa": tuKhoa,
            };

            return request;
        };
        
        let table = $('#dataGrid').DataTable({
            "pageLength": 15,
            "autoWidth": false,
            "ordering": false,
            "bInfo": false,
            "bDestroy": true,
            "lengthChange": false,
            "filter": false,
            "scrollY": "400px",
            "language": {
                "sProcessing": "Đang xử lý...",
                "sLengthMenu": "_MENU_",
                "sZeroRecords": "Không có dữ liệu",
                "sEmptyTable": "Bảng trống",
                "sInfo": "Hiện dòng _START_ đến _END_ trong tổng _TOTAL_ dòng",
                "sInfoEmpty": "Hiện dòng 0 đến 0 trong tổng 0 dòng",
                "sSearch": "Tìm kiếm",
                "sLoadingRecords": "Đang tải...",
                "paginate": {
                    next: '<i class="icon-fluent icon_fluent_chevron_right_filled"></i>',
                    previous: '<i class="icon-fluent icon_fluent_chevron_left_filled"></i>'
                }
            },

            "ajax": {
                url: `${BASEURL}/api/TuanMVC/SinhVienApi/Gets`,
                type: "POST",
                data: buildData,
                dataSrc: function (data) {
                    if (data && data.length > 0) {
                        for (let i = 0; i < data.length; i++) {
                            data[i].stt = i + 1;
                        }

                        return data;
                    }

                    return [];
                },
            },
            columnDefs: [
                {
                    targets: [6, 7],
                    render: function (data, type, row, meta) {
                        if (meta.col == 6) {
                            return `
                            <span title="Chỉnh sửa" class="edit-command-btn" id="n-${meta.row}">Edit</span>
                            <span>|<span/>
                            <span title="Xóa" class="delete-command-btn" id="n-${meta.row}">Delete</span>
                            <span>|<span/>
                            <span title="Thêm Vào Lớp" class="addc-command-btn" id="n-${meta.row}">AddC</span>
                            `;
                        }
                        if (meta.col == 7) {
                            return `<span title="Thêm Vắng" class="addb-command-btn" id="n-${meta.row}">Absent</span>`;
                        }
                        return data;
                    }
                }
            ],
            "columns": [
                { data: "stt", "width": "30px", "class": "stt-text center-align" },
                { data: "HoTen", "class": "left-align" },
                { data: "DiaChi", "class": "left-align" },
                { data: "NgaySinh", "class": "left-align" },
                { data: "SoDienThoai", "class": "left-align" },
                { data: "MaKhoa", "class": "left-align" }
            ]
        });

        // bắt sự kiện click nút delete-command-btn chức năng xóa học sinh
        $('#dataGrid tbody').on('click', '.delete-command-btn', function () {
            var id = $(this).attr("ID").match(/\d+/)[0];
            var data = $('#dataGrid').DataTable().row(id).data();

            $('#idDelete').val(data.MaSinhVien);

            $('#modalDelete').modal('show');
        });

        // bắt sự kiện click nút edit-command-btn chức năng chỉnh sửa thông tin học sinh
        $('#dataGrid tbody').on('click', '.edit-command-btn', function () {
            let id = $(this).attr("ID").match(/\d+/)[0];
            let data = $('#dataGrid').DataTable().row(id).data();

            $('#MaSinhVienEdit').val(data.MaSinhVien);
            $('#HoTenEdit').val(data.HoTen);
            $('#DiaChiEdit').val(data.DiaChi);
            $('#NgaySinhEdit').val(data.NgaySinh);
            $('#SoDienThoaiEdit').val(data.SoDienThoai);

            let MaKhoa = data.MaKhoa;
            $('#MaKhoaEdit').val(MaKhoa).trigger('change')

            $('#modalEdit').modal('show');
        });

        // bắt sự kiện click nút addb-command-btn thêm 1 học sinh vào danh sách vắng
        $('#dataGrid tbody').on('click', '.addb-command-btn', function () {
            let id = $(this).attr("ID").match(/\d+/)[0];
            let data = $('#dataGrid').DataTable().row(id).data();

            $('#MaSinhVienAddb').val(data.MaSinhVien);
            $('#HoTenAddb').val(data.HoTen);

            $('#modalAddb').modal('show');
        });

        // bắt sự kiện click nút addc-command-btn chức năng thêm học sinh mới vào 1 lớp
        $('#dataGrid tbody').on('click', '.addc-command-btn', function () {
            let id = $(this).attr("ID").match(/\d+/)[0];
            let data = $('#dataGrid').DataTable().row(id).data();

            $('#MaSinhVienAddc').val(data.MaSinhVien);
            $('#MaLopAddc').val(data.MaLop);

            $('#modalAddc').modal('show');
        });
    });


    function addData() {

        const HoTen = $('#HoTenAdd').val();
        const DiaChi = $('#DiaChiAdd').val();
        const NgaySinh = $('#NgaySinhAdd').val();
        const SoDienThoai = $('#SoDienThoaiAdd').val();
        const MaKhoa = $('#MaKhoaAdd').val();

        if (HoTen != null && HoTen != "") {
            const request = {
                "HoTen": HoTen,
                "DiaChi": DiaChi,
                "NgaySinh": NgaySinh,
                "SoDienThoai": SoDienThoai,
                "MaKhoa": MaKhoa,
            };

            $.ajax({
                url: `${BASEURL}/api/TuanMVC/SinhVienApi/Add`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(request),
                success: function (data) {
                    $('#dataGrid').DataTable().ajax.reload().draw();
                    $('#modalAdd').modal('hide');

                    $('#modalAdd input[type="text"]').val("");
                },
                error: function (error) {
                    console.log(error);
                }
            });

            $.ajax({
                url: `${BASEURL}/api/TuanMVC/SinhVienApi/check`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(requestCheck),
                success: function (data) {
                    $('#dataGrid').DataTable().ajax.reload().draw();
                    $('#modalAdd').modal('hide');

                    $('#modalAdd input[type="text"]').val("");
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
    };

    function editData() {
        const MaSinhVien = $('#MaSinhVienEdit').val();
        const HoTen = $('#HoTenEdit').val();
        const DiaChi = $('#DiaChiEdit').val();
        const NgaySinh = $('#NgaySinhEdit').val();
        const SoDienThoai = $('#SoDienThoaiEdit').val();
        const MaKhoa = $('#MaKhoaEdit').val();

        if (MaSinhVien != null && MaSinhVien != "") {
            const request = {
                "MaSinhVien": MaSinhVien,
                "HoTen": HoTen,
                "DiaChi": DiaChi,
                "NgaySinh": NgaySinh,
                "SoDienThoai": SoDienThoai,
                "MaKhoa": MaKhoa
            };

            $.ajax({
                url: `${BASEURL}/api/TuanMVC/SinhVienApi/Edit`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(request),
                success: function (data) {
                    $('#dataGrid').DataTable().ajax.reload().draw();
                    $('#modalEdit').modal('hide');
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
    };

    function deleteData() {
        const MaSinhVien = $('#idDelete').val();

        if (MaSinhVien != null && MaSinhVien != "") {
            $.ajax({
                url: `${BASEURL}/api/TuanMVC/SinhVienApi/Delete?data=${MaSinhVien}`,
                type: "POST",
                success: function (data) {
                    $('#dataGrid').DataTable().ajax.reload().draw();
                    $('#modalDelete').modal('hide');
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
    };

    function addbData() {
        const MaSinhVien = $('#MaSinhVienAddb').val();
        const HoTen = $('#HoTenAddb').val();
        const LyDo = $('#LyDoAddb').val();

        // Get the current date
        const currentDate = new Date();
        const formattedDate = currentDate.toISOString().slice(0, 10);

        if (MaSinhVien != null && MaSinhVien != "") {
            const request = {
                "MaSinhVien": MaSinhVien,
                "HoTen": HoTen,
                "NgayVang": formattedDate, // Use the current date here
                "LyDo": LyDo
            };

            $.ajax({
                url: `${BASEURL}/api/TuanMVC/SinhVienVangApi/Add`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(request),
                success: function (data) {
                    $('#dataGrid').DataTable().ajax.reload().draw();
                    $('#modalAddb').modal('hide');

                    // Clear input fields after successful addition
                    $('#modalAddb input[type="text"]').val("");
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
    };

    function addcData() {
        const MaSinhVien = $('#MaSinhVienAddc').val();
        const MaLop = $('#MaLopAddc').val();

        // Get the current date
        const currentDate = new Date();
        const formattedDate = currentDate.toISOString().slice(0, 10);

        if (MaSinhVien != null && MaSinhVien != "") {
            const request = {
                "MaSinhVien": MaSinhVien,
                "NgayDangKy": formattedDate,
                "MaLop": MaLop
            };

            $.ajax({
                url: `${BASEURL}/api/TuanMVC/SinhVienDkyApi/Add`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(request),
                success: function (data) {
                    $('#dataGrid').DataTable().ajax.reload().draw();
                    $('#modalAddc').modal('hide');

                    // Clear input fields after successful addition
                    $('#modalAddc input[type="text"]').val("");
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
    };

</script>