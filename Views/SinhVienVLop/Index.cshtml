<div style="text-align:center">
    <h3> Class management </h3>
</div>

<hr />

<div class="form-filter">
    <div class="form-row">
        <div style="margin: 10px 100px" class="form-group">
            <label style="margin-left:10px">Từ khóa</label>
            <input style="margin-left:10px; width:550px" class="1" type="text" id="tu-khoa-search" />

            <button style="width:92px; margin-left: 10px" type="button" class="1" id="filter-btn">Tìm kiếm</button>
            <button style="width:92px; margin: 0px 10px" type="button" class="1" id="filter-cancel-btn">Tất cả</button>
        </div>
    </div>
</div>

<hr />

<div style="text-align:center" class="Container">
    <a href="~/Module-Students/Student">Move to Student</a>
</div>

<div class="table-tree-wrapper table-form-field">
    <div style="width:100%; margin:0 auto;">
        <table id="dataGrid" class="table-border row-border compact" cellspacing="0">
            <thead>
                <tr>
                    <th style="width:100px" class="center-align">STT</th>
                    <th>MaSinhVien</th>
                    <th>HoTen</th>
                    <th>DiaChi</th>
                    <th>NgaySinh</th>
                    <th>SoDienThoai</th>
                    <th>MaLop</th>
                    <th>TenMon</th>
                    <th style="color:red; text-decoration: underline">Setting</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

<!-- Modal add-->
<div class="modal right fade" id="modalAdd" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Thêm mới</h4>
                @*<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>*@
            </div>
            <div class="modal-body">
                <input id="MaSinhVienAdd" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter Student ID" />
            </div>
            <div class="modal-body">
                <input id="HoTenAdd" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter Name" />
            </div>
            @*<div class="modal-body">
                    <input id="NgayVangAdd" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter day" />
                </div>*@
            <div class="modal-body">
                <input id="LyDoAdd" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter reason" />
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-secondary" onclick="addData()">Thêm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal edit-->
<div class="modal right fade" id="modalEdit" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Cập nhật</h4>
                @*<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>*@
            </div>
            <div class="#">
                <input id="MaVangEdit" type="hidden" class="form-control" />
            </div>
            <div class="#">
                <input id="MaSinhVienEdit" type="hidden" class="form-control" />
            </div>
            <div class="modal-body">
                <input id="HoTenEdit" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter Name" />
            </div>
            <div class="#">
                <input id="NgayVangEdit" type="hidden" class="form-control" />
            </div>
            <div class="modal-body">
                <input id="LyDoEdit" required="required" type="text" autocomplete="off" class="form-control" placeholder="Enter reason" />
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-secondary" onclick="editData()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal delete-->
<div class="modal right fade" id="modalDelete" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Xóa</h4>
                @*<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>*@
            </div>
            <div class="modal-body">
                <input id="idDelete" type="hidden" class="form-control" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-secondary" onclick="deleteData()">Xóa</button>
            </div>
        </div>
    </div>
</div>

<!-- script for table -->
<script>
    const url = window.location;
    const BASEURL = url.protocol + "//" + url.hostname + url.port;

    $(document).ready(function () {
        $('#filter-btn').on('click', function () {
            $('#dataGrid').DataTable().ajax.reload().draw();
        });

        $('#filter-cancel-btn').on('click', function () {
            $('#tu-khoa-search').val("");

            $('#dataGrid').DataTable().ajax.reload().draw();
        });

        $('#tu-khoa-search').on("keydown", function search(e) {
            if (e.keyCode == 13) {
                $('#dataGrid').DataTable().ajax.reload().draw();
            }
        });

        //$('#authoridAdd').select2({
        //    theme: 'bootstrap4',
        //    width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style',
        //    language: "vi",
        //    placeholder: $(this).data('placeholder'),
        //});

        function buildData() {
            let tuKhoa = $('#tu-khoa-search').val();

            const request = {
                "TuKhoa": tuKhoa,
            };

            return request;
        };
        // Khởi tạo bảng #DataGrid
        let table = $('#dataGrid').DataTable({
            "pageLength": 10,
            "autoWidth": false,
            "ordering": false,
            "bInfo": false,
            "bDestroy": true,
            "lengthMenu": [
                [5, 10, 15, 20, 25, 50, 100],
                ['5 per page', '10 per page (default)', '15 per page', '20 per page', '25 per page', '50 per page', '100 per page']
            ],
            "filter": false,
            "language": {
                "sProcessing": "Đang xử lý...",
                "sLengthMenu": "_MENU_",
                "sZeroRecords": "Không có dữ liệu",
                "sEmptyTable": "Bảng trống",
                "sInfo": "Hiện dòng _START_ đến _END_ trong tổng _TOTAL_ dòng",
                "sInfoEmpty": "Hiện dòng 0 đến 0 trong tổng 0 dòng",
                "sSearch": "Tìm kiếm",
                "sLoadingRecords": "Đang tải...",
                "paginate": {
                    next: '<i class="icon-fluent icon_fluent_chevron_right_filled"></i>',
                    previous: '<i class="icon-fluent icon_fluent_chevron_left_filled"></i>'
                }
            },
            "ajax": {
                url: `${BASEURL}/api/TuanMVC/SinhVienVLopApi/Gets`,
                type: "POST",
                data: buildData,
                dataSrc: function (data) {
                    if (data && data.length > 0) {
                        for (let i = 0; i < data.length; i++) {
                            data[i].stt = i + 1;
                        }

                        return data;
                    }

                    return [];
                },
            },
            columnDefs: [
                {
                    targets: 8,
                    render: function (data, type, row, meta) {
                        return `<span title="Chỉnh sửa" class="edit-command-btn" id=n-"${meta.row}">Edit</span>
                                <span title="Xóa" class="delete-command-btn" id=n-"${meta.row}">Delete</span>`;
                    }
                }
            ],
            "columns": [
                { data: "stt", "width": "30px", "class": "stt-text center-align" },
                { data: "MaSinhVien", "class": "left-align" },
                { data: "HoTen", "class": "left-align" },
                { data: "DiaChi", "class": "left-align" },
                { data: "NgaySinh", "class": "left-align" },
                { data: "SoDienThoai", "class": "left-align" },
                { data: "MaLop", "class": "left-align" },
                { data: "TenMon", "class": "left-align" },
            ]
        });

        // bắt sự kiện click nút delete-command-btn và gán giá trị của idDelete vào data.MaSinhVien
        $('#dataGrid tbody').on('click', '.delete-command-btn', function () {
            var id = $(this).attr("ID").match(/\d+/)[0];
            var data = $('#dataGrid').DataTable().row(id).data();

            $('#idDelete').val(data.MaVang);

            $('#modalDelete').modal('show');
        });

        // bắt sự kiện click nút edit-command-btn và gán giá trị của #... vào data...
        $('#dataGrid tbody').on('click', '.edit-command-btn', function () {
            let id = $(this).attr("ID").match(/\d+/)[0];
            let data = $('#dataGrid').DataTable().row(id).data();

            $('#MaVangEdit').val(data.MaVang);
            $('#MaSinhVienEdit').val(data.MaSinhVien);
            $('#HoTenEdit').val(data.HoTen);
            $('#NgayVangEdit').val(data.NgayVang);
            $('#LyDoEdit').val(data.LyDo);

            $('#modalEdit').modal('show');
        });
    });

    function addData() {
        const MaSinhVien = $('#MaSinhVienAdd').val();
        const HoTen = $('#HoTenAdd').val();
        const NgayVang = $('#NgayVangAdd').val();
        const LyDo = $('#LyDoAdd').val();

        if (HoTen != null && HoTen != "") {
            const request = {
                "MaSinhVien": MaSinhVien,
                "HoTen": HoTen,
                "NgayVang": NgayVang,  // Gán ngày hiện tại vào đây
                "LyDo": LyDo
            };

            $.ajax({
                url: `${BASEURL}/api/TuanMVC/SinhVienVangApi/Add`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(request),
                success: function (data) {
                    $('#dataGrid').DataTable().ajax.reload().draw();
                    $('#modalAdd').modal('hide');

                    $('#modalAdd input[type="text"]').val("");
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
    };


    function editData() {
        const MaVang = $('#MaVangEdit').val();
        const MaSinhVien = $('#MaSinhVienEdit').val();
        const HoTen = $('#HoTenEdit').val();
        const NgayVang = $('#NgayVangEdit').val();
        const LyDo = $('#LyDoEdit').val();

        if (MaSinhVien != null && MaSinhVien != "") {
            const request = {
                "MaVang": MaVang,
                "MaSinhVien": MaSinhVien,
                "HoTen": HoTen,
                "NgayVang": NgayVang,
                "LyDo": LyDo
            };

            $.ajax({
                url: `${BASEURL}/api/TuanMVC/SinhVienVangApi/Edit`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(request),
                success: function (data) {
                    $('#dataGrid').DataTable().ajax.reload().draw();
                    $('#modalEdit').modal('hide');
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
    };

    function deleteData() {
        const MaVang = $('#idDelete').val();

        if (MaVang != null && MaVang != "") {
            $.ajax({
                url: `${BASEURL}/api/TuanMVC/SinhVienVangApi/Delete?data=${MaVang}`,
                type: "POST",
                success: function (data) {
                    $('#dataGrid').DataTable().ajax.reload().draw();
                    $('#modalDelete').modal('hide');
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
    };

</script>